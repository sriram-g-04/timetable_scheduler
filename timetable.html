<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Generator</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Fredoka+One&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.33.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1d4ed8;
            --accent: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --error: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --break-color: #f97316;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f1f5f9;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image: radial-gradient(circle at 10% 20%, rgba(37, 99, 235, 0.05) 0%, rgba(59, 130, 246, 0.05) 90%);
            color: var(--text-primary);
        }
        
        .container {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            padding: 32px;
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            position: relative;
            overflow: visible;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        
        h1 {
            font-family: 'Fredoka One', cursive;
            color: var(--primary);
            text-align: center;
            margin-bottom: 24px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.05);
            letter-spacing: 0.5px;
        }
        
        .quote {
            font-style: italic;
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 1.1rem;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
        
        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 8px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        #createTableBtn {
            background-color: var(--primary);
            font-size: 1.2rem;
            padding: 14px 32px;
            display: block;
            margin: 0 auto 30px;
            border-radius: 12px;
        }
        
        .hidden {
            display: none !important;
        }
        
        form {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            display: flex;
            gap: 24px;
        }
        
        .form-section {
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1rem;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            background-color: var(--light);
        }
        
        input:focus, select:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .subject-input-group {
            background-color: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .subject-input-group label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .subject-input-group:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        #timetableWrapper {
            width: 100%;
            overflow-x: auto;
            margin: 30px 0;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        #timetable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 0 auto;
        }
        
        #timetable th, #timetable td {
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border-color);
            position: relative;
            transition: all 0.2s ease;
        }
        
        #timetable th {
            background-color: var(--primary);
            color: white;
            font-weight: 700;
            position: sticky;
            top: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        #timetable tr:nth-child(even) {
            background-color: var(--light);
        }
        
        #timetable tr:hover td {
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        #downloadButtons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 30px 0;
            padding-bottom: 30px;
            flex-wrap: wrap;
        }
        
        #verificationResults {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .verification-item {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .verification-good {
            background-color: rgba(16, 185, 129, 0.1);
            color: #065f46;
            border-left: 4px solid var(--success);
        }
        
        .verification-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: #92400e;
            border-left: 4px solid var(--warning);
        }
        
        .verification-error {
            background-color: rgba(239, 68, 68, 0.1);
            color: #991b1b;
            border-left: 4px solid var(--error);
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .break-period {
            background-color: var(--break-color) !important;
            color: white;
            font-weight: 600;
        }
        
        .staff-name {
            font-size: 0.8em;
            color: var(--text-secondary);
            display: block;
            margin-top: 6px;
            font-style: italic;
        }
        
        .advanced-settings {
            width: 300px;
            padding: 16px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        
        .transaction-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .transaction-message.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .transaction-message.error {
            background-color: var(--error);
        }
        
        .break-settings {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
        }
        
        .break-time-input {
            display: none;
            margin-top: 10px;
        }
        
        .generating-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            color: white;
            font-size: 1.2rem;
        }
        
        @media (max-width: 1024px) {
            form {
                flex-direction: column;
            }
            
            .advanced-settings {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            #downloadButtons {
                flex-direction: column;
                align-items: center;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚è∞ Timetable Generator üìö</h1>
        <div class="quote">"Energy and persistence conquer all things!" - Benjamin Franklin</div>
        <button id="createTableBtn">Create New Timetable</button>
        
        <div id="tableContainer" class="hidden">
            <form id="timetableForm">
                <div class="form-section">
                    <div class="form-group">
                        <label for="timetableName">Timetable Name:</label>
                        <input type="text" id="timetableName" name="timetableName" placeholder="e.g., Fall 2023 Schedule" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="days">Number of Working Days:</label>
                        <input type="number" id="days" name="days" min="1" max="7" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="periods">Number of Periods per Day:</label>
                        <input type="number" id="periods" name="periods" min="1" max="10" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="numSubjects">Number of Subjects:</label>
                        <input type="number" id="numSubjects" name="numSubjects" min="1" max="20" required>
                    </div>
                    
                    <div id="subjectInputs" class="input-grid"></div>
                </div>
                
                <div class="advanced-settings">
                    <h3 style="margin-top: 0; color: var(--primary);">Advanced Settings</h3>
                    
                    <div class="form-group">
                        <label for="numBreaks">Number of Breaks:</label>
                        <select id="numBreaks" name="numBreaks">
                            <option value="0">No breaks</option>
                            <option value="1">1 break</option>
                            <option value="2">2 breaks</option>
                            <option value="3">3 breaks</option>
                        </select>
                    </div>
                    
                    <div id="breakSettings" class="break-settings">
                        <div id="break1Input" class="break-time-input">
                            <label for="break1After">First break after period:</label>
                            <input type="number" id="break1After" name="break1After" min="1" max="9" value="2">
                        </div>
                        <div id="break2Input" class="break-time-input">
                            <label for="break2After">Second break after period:</label>
                            <input type="number" id="break2After" name="break2After" min="1" max="9" value="4">
                        </div>
                        <div id="break3Input" class="break-time-input">
                            <label for="break3After">Third break after period:</label>
                            <input type="number" id="break3After" name="break3After" min="1" max="9" value="6">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="preventConsecutive" name="preventConsecutive">
                            Prevent same subject in consecutive periods
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="balanceWorkload" name="balanceWorkload" checked>
                            Balance professor workload
                        </label>
                    </div>
                </div>
            </form>
            
            <div style="text-align: center;">
                <button type="submit" form="timetableForm" style="background-color: var(--primary); color: white; padding: 14px 40px;">
                    Generate Timetable
                </button>
            </div>
            
            <div id="timetableWrapper" class="hidden">
                <h2 id="timetableTitle" style="text-align: center; color: var(--primary); margin-bottom: 20px;"></h2>
                <table id="timetable"></table>
            </div>
            
            <div id="verificationResults" class="hidden"></div>
            
            <div id="downloadButtons" class="hidden">
                <div class="loader" id="pdfLoader"></div>
                <div class="loader" id="wordLoader"></div>
                <button id="downloadPdfBtn">üìä Download PDF</button>
                <button id="downloadWordBtn">üìù Download Word</button>
                <button id="downloadCsvBtn">üìã Download CSV</button>
                <button id="verifyTimetableBtn">üîç Verify Distribution</button>
            </div>
        </div>
    </div>

    <div class="transaction-message" id="transactionMessage"></div>
    <div id="generatingOverlay" class="generating-overlay hidden">
        <div class="loader"></div>
        <div>Generating timetable...</div>
    </div>

    <script>
        // DOM Elements
        const createTableBtn = document.getElementById('createTableBtn');
        const tableContainer = document.getElementById('tableContainer');
        const timetableForm = document.getElementById('timetableForm');
        const subjectInputs = document.getElementById('subjectInputs');
        const timetable = document.getElementById('timetable');
        const timetableWrapper = document.getElementById('timetableWrapper');
        const timetableTitle = document.getElementById('timetableTitle');
        const downloadButtons = document.getElementById('downloadButtons');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const downloadWordBtn = document.getElementById('downloadWordBtn');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const verifyTimetableBtn = document.getElementById('verifyTimetableBtn');
        const verificationResults = document.getElementById('verificationResults');
        const pdfLoader = document.getElementById('pdfLoader');
        const wordLoader = document.getElementById('wordLoader');
        const numBreaksInput = document.getElementById('numBreaks');
        const breakSettings = document.getElementById('breakSettings');
        const break1Input = document.getElementById('break1Input');
        const break2Input = document.getElementById('break2Input');
        const break3Input = document.getElementById('break3Input');
        const break1After = document.getElementById('break1After');
        const break2After = document.getElementById('break2After');
        const break3After = document.getElementById('break3After');
        const preventConsecutiveCheckbox = document.getElementById('preventConsecutive');
        const balanceWorkloadCheckbox = document.getElementById('balanceWorkload');
        const transactionMessage = document.getElementById('transactionMessage');
        const generatingOverlay = document.getElementById('generatingOverlay');

        // Energetic quotes related to education and time management
        const quotes = [
            "Success is no accident. It is hard work, perseverance, learning, studying, sacrifice and most of all, love of what you are doing! - Pel√©",
            "Energy and persistence conquer all things! - Benjamin Franklin",
            "The future belongs to those who believe in the beauty of their dreams! - Eleanor Roosevelt",
            "Don't watch the clock; do what it does. Keep going! - Sam Levenson",
            "You are never too old to set another goal or to dream a new dream! - C.S. Lewis",
            "The secret of getting ahead is getting started! - Mark Twain",
            "Believe you can and you're halfway there! - Theodore Roosevelt",
            "It always seems impossible until it's done! - Nelson Mandela",
            "Act as if what you do makes a difference. It does! - William James",
            "The way to get started is to quit talking and begin doing! - Walt Disney"
        ];

        let currentTimetable = [];
        let currentSubjects = [];
        let currentStaff = [];

        // Show transaction message
        function showTransaction(message, duration = 3000, isError = false) {
            transactionMessage.textContent = message;
            transactionMessage.classList.add('show');
            if (isError) {
                transactionMessage.classList.add('error');
            } else {
                transactionMessage.classList.remove('error');
            }
            
            setTimeout(() => {
                transactionMessage.classList.remove('show');
            }, duration);
        }

        // Show the form when "Create Timetable" is clicked
        createTableBtn.addEventListener('click', () => {
            tableContainer.classList.remove('hidden');
            createTableBtn.classList.add('hidden');
            showTransaction('Timetable creation started! Let\'s energize your schedule! ‚ö°');
            tableContainer.scrollIntoView({ behavior: 'smooth' });
        });

        // Handle break settings visibility
        numBreaksInput.addEventListener('change', (e) => {
            const numBreaks = parseInt(e.target.value);
            
            // Hide all break inputs first
            break1Input.style.display = 'none';
            break2Input.style.display = 'none';
            break3Input.style.display = 'none';
            
            // Show the needed ones
            if (numBreaks >= 1) break1Input.style.display = 'block';
            if (numBreaks >= 2) break2Input.style.display = 'block';
            if (numBreaks >= 3) break3Input.style.display = 'block';
            
            if (numBreaks > 0) {
                breakSettings.style.display = 'block';
                showTransaction(`Great! You've added ${numBreaks} break${numBreaks > 1 ? 's' : ''}. Now set when they should occur.`);
            } else {
                breakSettings.style.display = 'none';
            }
        });

        // Dynamically add subject input fields with staff assignment
        document.getElementById('numSubjects').addEventListener('input', (e) => {
            const numSubjects = parseInt(e.target.value);
            subjectInputs.innerHTML = '';

            for (let i = 1; i <= numSubjects; i++) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'subject-input-group';
                
                const subjectLabel = document.createElement('label');
                subjectLabel.textContent = `Subject ${i}`;
                
                const subjectInput = document.createElement('input');
                subjectInput.type = 'text';
                subjectInput.id = `subject${i}`;
                subjectInput.placeholder = `Enter subject name`;
                subjectInput.required = true;
                
                const staffLabel = document.createElement('label');
                staffLabel.textContent = `Professor/Teacher:`;
                staffLabel.style.marginTop = '10px';
                
                const staffInput = document.createElement('input');
                staffInput.type = 'text';
                staffInput.id = `staff${i}`;
                staffInput.placeholder = `Enter professor/teacher name`;
                staffInput.required = true;
                
                inputGroup.appendChild(subjectLabel);
                inputGroup.appendChild(subjectInput);
                inputGroup.appendChild(staffLabel);
                inputGroup.appendChild(staffInput);
                subjectInputs.appendChild(inputGroup);
            }
            
            showTransaction(`Added fields for ${numSubjects} subjects! Keep that energy going! üí™`);
        });

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Improved distribution with guaranteed period filling
        function distributeSubjects(subjects, staff, days, periods, numBreaks, breakPositions, preventConsecutive, balanceWorkload) {
            // Calculate total teaching periods (excluding breaks)
            const totalPeriods = days * periods;
            const totalBreaks = numBreaks * days;
            const teachingPeriods = totalPeriods - totalBreaks;
            
            // Validate we have enough periods for all subjects
            if (teachingPeriods < subjects.length) {
                throw new Error(`Not enough periods (${teachingPeriods}) for ${subjects.length} subjects. Increase periods or reduce subjects.`);
            }
            
            // Calculate base periods per subject
            const basePeriods = Math.floor(teachingPeriods / subjects.length);
            let extraPeriods = teachingPeriods % subjects.length;
            
            // Create subject pool with correct distribution
            let subjectPool = [];
            let staffPool = [];
            
            subjects.forEach((subject, index) => {
                const periodsForSubject = basePeriods + (extraPeriods-- > 0 ? 1 : 0);
                subjectPool.push(...Array(periodsForSubject).fill(subject));
                staffPool.push(...Array(periodsForSubject).fill(staff[index]));
            });
            
            // Shuffle while maintaining subject-staff pairing
            const combined = subjectPool.map((subject, i) => ({ subject, staff: staffPool[i] }));
            const shuffled = shuffleArray(combined);
            
            // Distribute subjects into timetable
            const timetable = Array(days).fill().map(() => Array(periods).fill(null));
            let poolIndex = 0;
            
            for (let day = 0; day < days; day++) {
                let periodIndex = 0;
                
                while (periodIndex < periods) {
                    // Check if current period is a break
                    if (breakPositions.includes(periodIndex)) {
                        timetable[day][periodIndex] = { subject: 'BREAK', staff: '' };
                        periodIndex++;
                        continue;
                    }
                    
                    // Get next subject from pool
                    if (poolIndex >= shuffled.length) {
                        // If we've exhausted the pool, reshuffle (shouldn't happen with proper math)
                        poolIndex = 0;
                    }
                    
                    const candidate = shuffled[poolIndex];
                    
                    // Check for consecutive same subjects if enabled
                    if (preventConsecutive) {
                        const prevDay = day > 0 ? timetable[day-1][periodIndex]?.subject : null;
                        const prevPeriod = periodIndex > 0 ? timetable[day][periodIndex-1]?.subject : null;
                        
                        if (candidate.subject !== prevDay && candidate.subject !== prevPeriod) {
                            timetable[day][periodIndex] = candidate;
                            periodIndex++;
                            poolIndex++;
                        } else {
                            // Find next suitable candidate
                            let found = false;
                            for (let i = poolIndex + 1; i < shuffled.length; i++) {
                                const altCandidate = shuffled[i];
                                if (altCandidate.subject !== prevDay && altCandidate.subject !== prevPeriod) {
                                    // Swap candidates
                                    [shuffled[poolIndex], shuffled[i]] = [shuffled[i], shuffled[poolIndex]];
                                    timetable[day][periodIndex] = shuffled[poolIndex];
                                    periodIndex++;
                                    poolIndex++;
                                    found = true;
                                    break;
                                }
                            }
                            
                            if (!found) {
                                // If no alternative found, place it anyway (better than empty slot)
                                timetable[day][periodIndex] = candidate;
                                periodIndex++;
                                poolIndex++;
                            }
                        }
                    } else {
                        // No consecutive prevention - just place the subject
                        timetable[day][periodIndex] = candidate;
                        periodIndex++;
                        poolIndex++;
                    }
                }
            }
            
            // Balance workload if enabled
            if (balanceWorkload) {
                balanceWorkloadAcrossDays(timetable, staff);
            }
            
            // Final verification
            verifyAllPeriodsFilled(timetable, subjects, staff);
            
            return timetable;
        }

        // Verify all periods are filled (fallback if any are empty)
        function verifyAllPeriodsFilled(timetable, subjects, staff) {
            for (let day = 0; day < timetable.length; day++) {
                for (let period = 0; period < timetable[day].length; period++) {
                    if (!timetable[day][period]) {
                        console.warn(`Empty slot found at day ${day}, period ${period}`);
                        // Fill with random subject as fallback
                        const randomIndex = Math.floor(Math.random() * subjects.length);
                        timetable[day][period] = {
                            subject: subjects[randomIndex],
                            staff: staff[randomIndex]
                        };
                    }
                }
            }
        }

        // Balance professor workload across days
        function balanceWorkloadAcrossDays(timetable, staffList) {
            const staffDays = {};
            const staffSet = new Set(staffList);
            
            // Initialize counts
            staffSet.forEach(staff => {
                staffDays[staff] = new Array(timetable.length).fill(0);
            });
            
            // Count current distribution
            for (let day = 0; day < timetable.length; day++) {
                for (let period = 0; period < timetable[day].length; period++) {
                    const entry = timetable[day][period];
                    if (entry.staff && entry.subject !== 'BREAK') {
                        staffDays[entry.staff][day]++;
                    }
                }
            }
            
            // Try to balance by swapping where possible
            for (let day = 0; day < timetable.length; day++) {
                for (let period = 0; period < timetable[day].length; period++) {
                    const currentEntry = timetable[day][period];
                    if (!currentEntry.staff || currentEntry.subject === 'BREAK') continue;
                    
                    const currentStaff = currentEntry.staff;
                    const currentDayCount = staffDays[currentStaff][day];
                    const avgPerDay = Math.ceil(staffDays[currentStaff].reduce((a, b) => a + b, 0) / timetable.length);
                    
                    if (currentDayCount > avgPerDay) {
                        // Try to find a swap candidate
                        for (let otherDay = 0; otherDay < timetable.length; otherDay++) {
                            if (otherDay === day) continue;
                            
                            if (staffDays[currentStaff][otherDay] < avgPerDay) {
                                // Find a period on the other day with different staff
                                for (let otherPeriod = 0; otherPeriod < timetable[otherDay].length; otherPeriod++) {
                                    const otherEntry = timetable[otherDay][otherPeriod];
                                    if (otherEntry.staff && otherEntry.staff !== currentStaff && otherEntry.subject !== 'BREAK') {
                                        const otherStaff = otherEntry.staff;
                                        const otherStaffDayCount = staffDays[otherStaff][otherDay];
                                        const otherStaffAvg = Math.ceil(staffDays[otherStaff].reduce((a, b) => a + b, 0) / timetable.length);
                                        
                                        if (otherStaffDayCount > otherStaffAvg) {
                                            // Perform swap
                                            const tempSubject = currentEntry.subject;
                                            const tempStaff = currentEntry.staff;
                                            
                                            currentEntry.subject = otherEntry.subject;
                                            currentEntry.staff = otherEntry.staff;
                                            
                                            otherEntry.subject = tempSubject;
                                            otherEntry.staff = tempStaff;
                                            
                                            // Update counts
                                            staffDays[currentStaff][day]--;
                                            staffDays[currentStaff][otherDay]++;
                                            staffDays[otherStaff][otherDay]--;
                                            staffDays[otherStaff][day]++;
                                            
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // Display the timetable in the UI
        function displayTimetable(timetable, days, periods) {
            const tableElement = document.getElementById('timetable');
            tableElement.innerHTML = ''; // Clear existing content
            
            const headerRow = document.createElement('tr');
            
            // Create header with Day/Period
            const dayPeriodHeader = document.createElement('th');
            dayPeriodHeader.textContent = 'Day/Period';
            headerRow.appendChild(dayPeriodHeader);
            
            // Create period headers (accounting for breaks)
            let displayPeriod = 0;
            for (let p = 0; p < periods; p++) {
                if (timetable[0][p].subject === 'BREAK') continue;
                displayPeriod++;
                const periodHeader = document.createElement('th');
                periodHeader.textContent = `Period ${displayPeriod}`;
                headerRow.appendChild(periodHeader);
            }
            tableElement.appendChild(headerRow);
            
            // Create day rows
            for (let day = 0; day < days; day++) {
                const row = document.createElement('tr');
                const dayCell = document.createElement('td');
                dayCell.textContent = `Day ${day + 1}`;
                dayCell.style.fontWeight = 'bold';
                row.appendChild(dayCell);
                
                displayPeriod = 0;
                for (let period = 0; period < periods; period++) {
                    const entry = timetable[day][period];
                    
                    // Skip creating cells for break periods
                    if (entry.subject === 'BREAK') continue;
                    
                    displayPeriod++;
                    const cell = document.createElement('td');
                    cell.textContent = entry.subject;
                    
                    // Add staff name if available
                    if (entry.staff) {
                        const staffSpan = document.createElement('span');
                        staffSpan.className = 'staff-name';
                        staffSpan.textContent = entry.staff;
                        cell.appendChild(staffSpan);
                    }
                    
                    // Color coding
                    const subjectIndex = currentSubjects.indexOf(entry.subject);
                    const hue = (subjectIndex * 50) % 360;
                    cell.style.backgroundColor = `hsla(${hue}, 80%, 90%, 0.7)`;
                    cell.style.border = '1px solid var(--border-color)';
                    
                    row.appendChild(cell);
                }
                tableElement.appendChild(row);
            }
        }

        // Generate the table when the form is submitted
        document.getElementById('timetableForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const timetableName = document.getElementById('timetableName').value;
            const days = parseInt(document.getElementById('days').value);
            const periods = parseInt(document.getElementById('periods').value);
            const numSubjects = parseInt(document.getElementById('numSubjects').value);
            const numBreaks = parseInt(numBreaksInput.value) || 0;
            
            // Get break positions
            const breakPositions = [];
            if (numBreaks >= 1) breakPositions.push(parseInt(break1After.value) - 1);
            if (numBreaks >= 2) breakPositions.push(parseInt(break2After.value) - 1);
            if (numBreaks >= 3) breakPositions.push(parseInt(break3After.value) - 1);
            
            const preventConsecutive = preventConsecutiveCheckbox.checked;
            const balanceWorkload = balanceWorkloadCheckbox.checked;
            const subjectFields = document.querySelectorAll('#subjectInputs input[id^="subject"]');
            const staffFields = document.querySelectorAll('#subjectInputs input[id^="staff"]');
            
            // Validate subject names
            const subjects = [];
            const staff = [];
            let isValid = true;
            
            subjectFields.forEach((input, index) => {
                const subject = input.value.trim();
                const teacher = staffFields[index].value.trim();
                
                if (!subject || !teacher) {
                    input.style.borderColor = subject ? '#ddd' : 'var(--error)';
                    staffFields[index].style.borderColor = teacher ? '#ddd' : 'var(--error)';
                    isValid = false;
                } else {
                    input.style.borderColor = '#ddd';
                    staffFields[index].style.borderColor = '#ddd';
                    subjects.push(subject);
                    staff.push(teacher);
                }
            });
            
            if (!isValid) {
                showTransaction('Please enter names for all subjects and professors! Stay focused! üéØ', 4000, true);
                return;
            }
            
            if (subjects.length !== numSubjects) {
                showTransaction('Number of subjects entered doesn\'t match the specified count! Double check! üëÄ', 4000, true);
                return;
            }

            // Clear previous table and results
            timetable.innerHTML = '';
            verificationResults.innerHTML = '';
            verificationResults.classList.add('hidden');
            
            // Store current subjects and staff
            currentSubjects = [...subjects];
            currentStaff = [...staff];
            
            // Show generating overlay
            generatingOverlay.classList.remove('hidden');
            
            try {
                // Small delay to allow UI to update
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Distribute subjects using improved algorithm
                currentTimetable = distributeSubjects(
                    subjects, 
                    staff, 
                    days, 
                    periods, 
                    numBreaks, 
                    breakPositions, 
                    preventConsecutive,
                    balanceWorkload
                );

                // Set timetable title
                timetableTitle.textContent = timetableName || 'Work Timetable';
                
                // Display the timetable
                displayTimetable(currentTimetable, days, periods);
                
                timetableWrapper.classList.remove('hidden');
                downloadButtons.classList.remove('hidden');
                showTransaction('Timetable generated successfully! Ready to conquer your schedule! üöÄ');
                timetableWrapper.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error("Generation error:", error);
                showTransaction(`Error: ${error.message}`, 5000, true);
            } finally {
                generatingOverlay.classList.add('hidden');
            }
        });

        // Verify timetable distribution
        verifyTimetableBtn.addEventListener('click', () => {
            if (currentTimetable.length === 0) {
                showTransaction('Please generate a timetable first! Let\'s get started! üí™', 3000, true);
                return;
            }

            verificationResults.innerHTML = '';
            verificationResults.classList.remove('hidden');
            
            // Calculate subject counts
            const subjectCounts = {};
            const staffCounts = {};
            const staffDailyCounts = {};
            currentSubjects.forEach(subject => {
                subjectCounts[subject] = 0;
            });
            
            currentStaff.forEach(staff => {
                staffCounts[staff] = 0;
                staffDailyCounts[staff] = new Array(currentTimetable.length).fill(0);
            });

            // Count occurrences of each subject and staff
            currentTimetable.forEach((day, dayIndex) => {
                day.forEach(entry => {
                    if (entry.subject && entry.subject !== 'BREAK') {
                        subjectCounts[entry.subject]++;
                        if (entry.staff) {
                            staffCounts[entry.staff]++;
                            staffDailyCounts[entry.staff][dayIndex]++;
                        }
                    }
                });
            });

            const totalPeriods = currentTimetable.length * currentTimetable[0].length;
            const breakCount = currentTimetable.flat().filter(x => x.subject === 'BREAK').length;
            const teachingPeriods = totalPeriods - breakCount;
            const idealCount = Math.floor(teachingPeriods / currentSubjects.length);
            
            let isBalanced = true;
            let hasConsecutive = false;
            let hasUnbalancedWorkload = false;
            
            // Check for consecutive same subjects
            for (let day = 0; day < currentTimetable.length; day++) {
                for (let period = 1; period < currentTimetable[day].length; period++) {
                    const current = currentTimetable[day][period];
                    const previous = currentTimetable[day][period-1];
                    
                    if (current.subject !== 'BREAK' && previous.subject !== 'BREAK' && 
                        current.subject === previous.subject) {
                        hasConsecutive = true;
                        break;
                    }
                }
                if (hasConsecutive) break;
            }
            
            // Create verification report
            const reportTitle = document.createElement('h3');
            reportTitle.textContent = 'Timetable Verification Report';
            reportTitle.style.color = 'var(--primary)';
            reportTitle.style.marginTop = '0';
            verificationResults.appendChild(reportTitle);
            
            // Summary stats
            const stats = document.createElement('div');
            stats.className = 'verification-item';
            stats.innerHTML = `
                <strong>Total Periods:</strong> ${totalPeriods} (${breakCount} break periods)<br>
                <strong>Teaching Periods:</strong> ${teachingPeriods}<br>
                <strong>Subjects:</strong> ${currentSubjects.length}<br>
                <strong>Professors:</strong> ${new Set(currentStaff).size}<br>
                <strong>Ideal periods per subject:</strong> ${idealCount} or ${idealCount + 1}
            `;
            verificationResults.appendChild(stats);
            
            // Check each subject's count
            const subjectHeader = document.createElement('h4');
            subjectHeader.textContent = 'Subject Distribution';
            subjectHeader.style.color = 'var(--text-primary)';
            verificationResults.appendChild(subjectHeader);
            
            Object.entries(subjectCounts).forEach(([subject, count]) => {
                const item = document.createElement('div');
                item.className = 'verification-item';
                
                if (count === idealCount || count === idealCount + 1) {
                    item.classList.add('verification-good');
                    item.innerHTML = `‚úì <strong>${subject}</strong>: ${count} periods (well distributed)`;
                } else {
                    item.classList.add('verification-warning');
                    item.innerHTML = `‚ö† <strong>${subject}</strong>: ${count} periods (should be ${idealCount} or ${idealCount + 1})`;
                    isBalanced = false;
                }
                
                verificationResults.appendChild(item);
            });
            
            // Check staff distribution
            const staffHeader = document.createElement('h4');
            staffHeader.textContent = 'Professor/Teacher Workload';
            staffHeader.style.color = 'var(--text-primary)';
            verificationResults.appendChild(staffHeader);
            
            Object.entries(staffCounts).forEach(([staff, count]) => {
                const item = document.createElement('div');
                item.className = 'verification-item';
                
                // Calculate daily distribution
                const dailyStats = staffDailyCounts[staff].map((dayCount, i) => 
                    `Day ${i+1}: ${dayCount}`).join(', ');
                
                if (count >= idealCount - 1 && count <= idealCount + 2) {
                    item.classList.add('verification-good');
                    item.innerHTML = `‚úì <strong>${staff}</strong>: ${count} total periods (${dailyStats})`;
                } else {
                    item.classList.add('verification-warning');
                    item.innerHTML = `‚ö† <strong>${staff}</strong>: ${count} periods (${dailyStats}) - may be over/under allocated`;
                    hasUnbalancedWorkload = true;
                }
                
                verificationResults.appendChild(item);
            });
            
            // Check for consecutive subjects
            const consecutiveCheck = document.createElement('div');
            consecutiveCheck.className = `verification-item ${hasConsecutive ? 'verification-error' : 'verification-good'}`;
            consecutiveCheck.innerHTML = hasConsecutive 
                ? `‚ö† <strong>Consecutive subjects found</strong>: Some subjects appear in consecutive periods`
                : `‚úì <strong>No consecutive subjects</strong>: Great distribution!`;
            verificationResults.appendChild(consecutiveCheck);
            
            // Add summary
            const summary = document.createElement('div');
            summary.className = `verification-item ${isBalanced ? 'verification-good' : 'verification-warning'}`;
            summary.innerHTML = isBalanced 
                ? '‚úì <strong>Excellent!</strong> All subjects are evenly distributed. Keep up the great work! üåü'
                : '‚ö† <strong>Warning:</strong> Some subjects are not perfectly balanced. Consider regenerating the timetable.';
            verificationResults.appendChild(summary);
            
            // Add regenerate button
            const regenerateBtn = document.createElement('button');
            regenerateBtn.textContent = 'üîÑ Regenerate Timetable';
            regenerateBtn.style.marginTop = '10px';
            regenerateBtn.addEventListener('click', () => {
                document.getElementById('timetableForm').dispatchEvent(new Event('submit'));
                showTransaction('Regenerating timetable with fresh energy! ‚ö°');
            });
            verificationResults.appendChild(regenerateBtn);
            
            showTransaction('Verification completed! Everything looks powerful! üí•');
            verificationResults.scrollIntoView({ behavior: 'smooth' });
        });

        // Download the timetable as PDF
        downloadPdfBtn.addEventListener('click', () => {
            pdfLoader.style.display = 'block';
            downloadPdfBtn.disabled = true;
            
            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape'
                });

                // Add title
                doc.setFontSize(20);
                doc.setTextColor(37, 99, 235);
                doc.text(timetableTitle.textContent, 14, 15);
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                
                // Add random energetic quote
                const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                doc.text(randomQuote, 14, 22, { maxWidth: 250 });

                // Extract table data
                const table = document.getElementById('timetable');
                const rows = table.rows;
                const data = [];
                const styles = [];

                // Headers
                const headerData = ['Day/Period']; // First header remains
                
                // Add period headers (skipping breaks)
                let periodCount = 0;
                for (let j = 1; j < rows[0].cells.length; j++) {
                    periodCount++;
                    headerData.push(rows[0].cells[j].textContent);
                }
                
                data.push(headerData);
                styles.push({
                    fillColor: [37, 99, 235],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                });

                // Body
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const rowData = [];
                    const rowStyles = {};
                    
                    // Add day cell
                    rowData.push(row.cells[0].textContent);
                    
                    // Add period cells (skipping breaks)
                    for (let j = 1; j < row.cells.length; j++) {
                        const cell = row.cells[j];
                        let cellContent = cell.textContent;
                        
                        // Include staff name if present
                        const staff = cell.querySelector('.staff-name');
                        if (staff) {
                            cellContent += '\n' + staff.textContent;
                        }
                        
                        rowData.push(cellContent);
                        
                        // Handle break period styling
                        if (cell.classList.contains('break-period')) {
                            rowStyles[`fillColor${j}`] = [249, 115, 22];
                            rowStyles[`textColor${j}`] = [255, 255, 255];
                        } else {
                            const bgColor = cell.style.backgroundColor;
                            if (bgColor) {
                                rowStyles[`fillColor${j}`] = hexToRgb(bgColor) || [255, 255, 255];
                            }
                        }
                    }
                    data.push(rowData);
                    styles.push(rowStyles);
                }

                // Generate PDF table
                doc.autoTable({
                    head: [data[0]],
                    body: data.slice(1),
                    startY: 30,
                    styles: {
                        cellPadding: 5,
                        fontSize: 10,
                        valign: 'middle',
                        lineColor: [200, 200, 200],
                        lineWidth: 0.5
                    },
                    headStyles: {
                        fillColor: [37, 99, 235],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    didParseCell: function(data) {
                        if (data.row.index >= 0) {
                            // Apply background colors
                            if (styles[data.row.index + 1]?.[`fillColor${data.column.index}`]) {
                                data.cell.styles.fillColor = styles[data.row.index + 1][`fillColor${data.column.index}`];
                            }
                            
                            // Apply text colors for break periods
                            if (styles[data.row.index + 1]?.[`textColor${data.column.index}`]) {
                                data.cell.styles.textColor = styles[data.row.index + 1][`textColor${data.column.index}`];
                            }
                            
                            // Smaller font for staff names
                            if (data.cell.text[0]?.includes('\n')) {
                                data.cell.styles.fontSize = 8;
                                data.cell.styles.cellPadding = { top: 2, right: 2, bottom: 2, left: 2 };
                            }
                        }
                    }
                });

                doc.save(`${timetableTitle.textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_timetable.pdf`);
                pdfLoader.style.display = 'none';
                downloadPdfBtn.disabled = false;
                showTransaction('PDF downloaded! Your schedule is ready to energize your week! ‚ö°');
            }, 100);
        });

        // Helper function to convert hex to RGB
        function hexToRgb(hex) {
            if (hex.startsWith('rgba')) {
                const rgb = hex.match(/\d+/g);
                return [parseInt(rgb[0]), parseInt(rgb[1]), parseInt(rgb[2])];
            }
            
            if (hex.startsWith('hsla')) {
                const hsl = hex.match(/\d+/g);
                const h = parseInt(hsl[0]) / 360;
                const s = parseInt(hsl[1]) / 100;
                const l = parseInt(hsl[2]) / 100;
                
                let r, g, b;
                
                if (s === 0) {
                    r = g = b = l;
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    };
                    
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                
                return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
            }
            
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [
                parseInt(result[1], 16),
                parseInt(result[2], 16),
                parseInt(result[3], 16)
            ] : null;
        }

        // Download the timetable as Word
        downloadWordBtn.addEventListener('click', () => {
            wordLoader.style.display = 'block';
            downloadWordBtn.disabled = true;
            
            setTimeout(() => {
                // Create HTML table structure with styles
                let tableHTML = '<table border="1" cellspacing="0" cellpadding="5" style="border-collapse: collapse; width: 100%;">';
                
                // Add header row
                const table = document.getElementById('timetable');
                const rows = table.rows;
                
                // Header row
                tableHTML += '<tr style="background-color: #2563eb; color: white;">';
                for (let j = 0; j < rows[0].cells.length; j++) {
                    tableHTML += `<th style="padding: 8px; text-align: center; font-weight: bold;">${rows[0].cells[j].textContent}</th>`;
                }
                tableHTML += '</tr>';
                
                // Data rows
                for (let i = 1; i < rows.length; i++) {
                    tableHTML += '<tr>';
                    for (let j = 0; j < rows[i].cells.length; j++) {
                        const cell = rows[i].cells[j];
                        let cellStyle = 'padding: 8px; text-align: center;';
                        
                        if (cell.classList.contains('break-period')) {
                            cellStyle += 'background-color: #f97316; color: white; font-weight: bold;';
                        } else if (cell.style.backgroundColor) {
                            cellStyle += `background-color: ${cell.style.backgroundColor};`;
                        }
                        
                        // Combine subject and staff
                        let cellContent = cell.textContent;
                        if (j > 0 && !cell.classList.contains('break-period')) {
                            const staff = cell.querySelector('.staff-name');
                            if (staff) {
                                cellContent += '<br><span style="font-size: 0.8em; font-style: italic; color: #64748b;">' + staff.textContent + '</span>';
                            }
                        }
                        
                        tableHTML += `<td style="${cellStyle}">${cellContent}</td>`;
                    }
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</table>';
                
                const template = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    <title>${timetableTitle.textContent}</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        h1 { color: #2563eb; }
                        .quote { font-style: italic; color: #64748b; }
                    </style>
                </head>
                <body>
                    <h1>${timetableTitle.textContent}</h1>
                    <p class="quote">${quotes[Math.floor(Math.random() * quotes.length)]}</p>
                    ${tableHTML}
                </body>
                </html>
                `;
                
                const blob = new Blob([template], { type: 'application/msword' });
                saveAs(blob, `${timetableTitle.textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_timetable.doc`);
                wordLoader.style.display = 'none';
                downloadWordBtn.disabled = false;
                showTransaction('Word document downloaded! Your powerful schedule is ready! üéØ');
            }, 100);
        });

        // Download the timetable as CSV
        downloadCsvBtn.addEventListener('click', () => {
            const table = document.getElementById('timetable');
            const rows = table.rows;
            let csvContent = '';
            
            // Process rows
            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].cells;
                
                for (let j = 0; j < cols.length; j++) {
                    const cell = cols[j];
                    let cellContent = cell.textContent;
                    
                    // Include staff name if present
                    if (j > 0 && !cell.classList.contains('break-period')) {
                        const staff = cell.querySelector('.staff-name');
                        if (staff) {
                            cellContent += ' (' + staff.textContent + ')';
                        }
                    }
                    
                    // Escape quotes and wrap in quotes
                    cellContent = cellContent.replace(/"/g, '""');
                    row.push('"' + cellContent + '"');
                }
                
                csvContent += row.join(',') + '\r\n';
            }
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `${timetableTitle.textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_timetable.csv`);
            showTransaction('CSV file downloaded! Ready to energize your planning! ‚ö°');
        });
    </script>
</body>
</html>